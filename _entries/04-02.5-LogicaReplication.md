---
sectionid: databaseReplication
sectionclass: h2
parent-id: businesscont-sec
title: Database replication
hide: false
published: true
---

### Native logical replication
Logical replication uses the terms 'publisher' and 'subscriber'.
* The publisher is the PostgreSQL database you're sending data from.
* The subscriber is the PostgreSQL database you're sending data to.

On the CloudShell run the following command to create new flexible server
```sh
az postgres flexible-server create --vnet spoke-vnet --subnet subnet-02 --resource-group PG-Workshop \
  --name replication-flex-$$ --admin-user replica --admin-password 'PkG3zk&SKt' \
  --sku-name Standard_B1ms --tier Burstable --storage-size 128 \
  --tags "key=replica" --version 13 --high-availability Disabled
```

![Azure Replication](media/CreateReplica.png)

While the the the replication server being deployed, you can continue working on the primary database to change the parameters:


* Go to server parameters page on the portal.
* Set the server parameter **wal_level** to logical.
* Update **max_worker_processes** parameter value to at least 16. Otherwise, you may run into issues like WARNING: *out of background worker slots*.
* Save the changes and restart the server to apply the **wal_level** change.
* Confirm that your PostgreSQL instance allows network traffic from your connecting resource.
* Grant the admin user replication permissions.

```SQL
ALTER ROLE <adminname> WITH REPLICATION;
```
The adminname is the PostgreSQL user that we used while creating the database in first section.

While on the primary database, we should create the publication

```SQL
\c quiz
CREATE PUBLICATION answers_pub FOR TABLE  answers;
```

Now. we can check if the database replica has finished, the output should be like the following the picture, 
![Azure Replication Output](media/CreateReplica-output.png)

Once the replica server deployed, we need to change the **Private DNS** to private.postgresql.database.azure.com

 ![Azure Replication Output](media/pg-networking-dns.png)
 

*Notice the name of the PostgreSQL name it should be "replication-flex-<**Random Number**>.postgres.database.azure.com"*

Log in to the Jump-box (DNS) and access the new created database (change 123 to match with your number):

```sh
export PGPASSWORD='PkG3zk&SKt'; psql -d postgres  -U replica  -h replication-flex-<123>>.postgres.database.azure.com
```

![Azure replica](media/access-replica-DB.png)

Once connected, create the DDL of the database:

```SQL
CREATE DATABASE quiz;
\connect quiz

CREATE TABLE public.answers (
    question_id serial NOT NULL,
    answer text NOT NULL,
    is_correct boolean NOT NULL DEFAULT FALSE
);
```

![Azure backup](media/CreateDDLreplica.png)

Now, we want to create the connection, make sure that you change the parameters to match your environment.
```SQL
CREATE SUBSCRIPTION sub CONNECTION 'host=192.168.1.132 user=diaa dbname=quiz password=@n6DnfN&P' PUBLICATION answers_pub;
```

Check the answers table, the table shouldn't be 0 rows :
```SQL
table answers;
```

![Azure backup](media/replica-answers.png)
