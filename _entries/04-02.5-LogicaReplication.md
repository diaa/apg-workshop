---
sectionid: databaseReplication
sectionclass: h2
parent-id: businesscont-sec
title: Database replication
hide: false
published: true
---

### Native Logical Replication

Logical replication uses the terms **publisher** and **subscriber**:
- The **publisher** is the PostgreSQL database you are sending data from.
- The **subscriber** is the PostgreSQL database you are sending data to.

To create a new flexible server, run the following command in CloudShell:

```sh
az postgres flexible-server create --vnet spoke-vnet --subnet subnet-02 --resource-group PG-Workshop \
  --name replication-flex-$$ --admin-user replica --admin-password 'PkG3zk&SKt' \
  --sku-name Standard_B1ms --tier Burstable --storage-size 128 \
  --tags "key=replica" --version 13 --high-availability Disabled
```

![Azure Replication](media/CreateReplica.png)

While the replication server is being deployed, you can update the primary database parameters:

1. Go to the server parameters page in the Azure portal.
2. Set the server parameter **wal_level** to `logical`.
3. Update **max_worker_processes** to at least `16`. Otherwise, you may encounter issues such as:  
   `WARNING: out of background worker slots`.
4. Save the changes and restart the server to apply the **wal_level** change.
5. Confirm that your PostgreSQL instance allows network traffic from your connecting resource.
6. Grant the admin user replication permissions:

```SQL
ALTER ROLE <adminname> WITH REPLICATION;
```
Replace `<adminname>` with the PostgreSQL user you created in the first section.

On the primary database, create the publication:

```SQL
\c quiz
CREATE PUBLICATION answers_pub FOR TABLE answers;
```

Check if the database replica has finished deploying. The output should look like the following image:

![Azure Replication Output](media/CreateReplica-output.png)

Once the replica server is deployed, update the **Private DNS** to `private.postgresql.database.azure.com`:

![Azure Replication Output](media/pg-networking-dns.png)

*Note the name of the PostgreSQL server: `replication-flex-<Random Number>.postgres.database.azure.com`.*

Log in to the jump-box (DNS) and access the newly created database (replace `<123>` with your actual number):

```sh
export PGPASSWORD='PkG3zk&SKt'
psql -d postgres -U replica -h replication-flex-<123>.postgres.database.azure.com
```

![Azure replica](media/access-replica-DB.png)

Once connected, create the database and table:

```SQL
CREATE DATABASE quiz;
\connect quiz

CREATE TABLE public.answers (
    question_id serial NOT NULL,
    answer text NOT NULL,
    is_correct boolean NOT NULL DEFAULT FALSE
);
```

![Azure backup](media/CreateDDLreplica.png)

Now, create the subscription. Make sure to change the connection parameters to match your environment:

```SQL
CREATE SUBSCRIPTION sub CONNECTION 'host=192.168.1.132 user=diaa dbname=quiz password=@n6DnfN&P' PUBLICATION answers_pub;
```

Check the `answers` table. It should not be empty:

```SQL
TABLE answers;
```

![Azure backup](media/replica-answers.png)